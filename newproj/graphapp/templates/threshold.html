<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Thresholds</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/StyleSheet.css' %}">

    <!--Chart.js and Chart.js Annotation Plugin (need this)-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
</head>
<body>
<header class="main-header">
    <h1>Temperature Threshold System</h1>
</header>


<nav>
    <ul class="navbar">
        <li><a href="{% url 'plot_general' %}">Show Graph</a></li>
        <li><a href="{% url 'device_thresholds' %}">Set Thresholds</a></li>
        <!-- added link for DeviceGraph page -->
        <li><a href="{% url 'device_options' %}">Device Graphs</a></li>
    </ul>
</nav>

<h1>Set Temperature Thresholds</h1>

<table>
    <thead>
    <tr>
        <th>Device</th>
        <th>Threshold (Low | High)</th>
        <th>Graph</th>
        <th>Alert</th>
    </tr>
    </thead>
    <tbody>
    {% for device in devices %}
    <tr>
        <td>{{ device.name }}</td>
        <td>
            <span class="threshold" id="threshold_{{ device.name }}" onclick="setThreshold('{{ device.name }}')">
                Set Threshold
            </span>
        </td>
        <td>
            <canvas id="graph_{{ device.name }}" width="400" height="200"></canvas>
        </td>
        <td>
            <span class="alert-message" id="alert_{{ device.name }}">
                All good! <span class="alert-good">✅</span> <!-- This is the default message -->
            </span>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- JavaScript Section -->
<script>
    // Register the Chart.js Annotation plugin
    Chart.register(ChartAnnotation.Annotation);

    // Function to create a graph
    function createGraph(deviceName, lowThreshold, highThreshold) {
        const ctx = document.getElementById(`graph_${deviceName}`).getContext('2d');

        const data = {
            labels: [],
            datasets: []
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        min: Math.min(lowThreshold, 0) - 5, // Adjust min to allow negative thresholds
                        max: Math.max(lowThreshold, highThreshold) + 5 // Adjust y-axis based on thresholds
                    }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            lowLine: {
                                type: 'line',
                                yMin: lowThreshold,
                                yMax: lowThreshold,
                                borderColor: 'red',
                                borderWidth: 2,
                                label: {
                                    content: 'Low Threshold',
                                    enabled: true,
                                    position: 'start'
                                }
                            },
                            highLine: {
                                type: 'line',
                                yMin: highThreshold,
                                yMax: highThreshold,
                                borderColor: 'green',
                                borderWidth: 2,
                                label: {
                                    content: 'High Threshold',
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        }
                    }
                }
            }
        };

        // Create and return the graph
        new Chart(ctx, config);
    }

 function setThreshold(deviceName) {
        const lowThreshold = Number(prompt('Enter low threshold:')); // Convert to number
        const highThreshold = Number(prompt('Enter high threshold:')); // Convert to number

        if (!isNaN(lowThreshold) && !isNaN(highThreshold)) { // Validate input
            document.getElementById(`threshold_${deviceName}`).textContent = `Low: ${lowThreshold} | High: ${highThreshold}`;
            createGraph(deviceName, lowThreshold, highThreshold);

            // Check if the thresholds are acceptable and update the alert status
            const alertElement = document.getElementById(`alert_${deviceName}`);
            if (lowThreshold < highThreshold) {
                alertElement.innerHTML = '<span class="alert-good">✅</span> All Good!'; // Display check mark if within range
                alertElement.classList.remove('alert-warning');
                alertElement.classList.add('alert-good');
            } else {
                alertElement.innerHTML = '<span class="alert-warning">❌</span> Warning'; // Display red cross if thresholds are not valid
                alertElement.classList.remove('alert-good');
                alertElement.classList.add('alert-warning');
            }
        } else {
            alert("Please enter valid numbers for both thresholds.");
        }
    }
</script>

</body>
</html>
